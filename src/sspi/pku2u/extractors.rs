use std::convert::{TryFrom, TryInto};

use oid::ObjectIdentifier;
use picky_asn1::wrapper::IntegerAsn1;
use picky_asn1_der::application_tag::ApplicationTag;
use picky_asn1_der::Asn1RawDer;
use picky_asn1_x509::content_info::ContentValue;
use picky_asn1_x509::oids::PKINIT_DH_KEY_DATA;
use picky_asn1_x509::signed_data::SignedData;
use picky_krb::constants::types::PA_PK_AS_REP;
use picky_krb::messages::AsRep;
use picky_krb::pkinit::{DhRepInfo, KdcDhKeyInfo, PaPkAsRep};
use serde::Deserialize;

use super::generators::DH_NONCE_LEN;
use crate::{Error, ErrorKind, Result};

pub fn extract_krb_rep<'a, T: Deserialize<'a>>(mut data: &'a [u8]) -> Result<(T, &'a [u8])> {
    let _oid: ApplicationTag<Asn1RawDer, 0> =
        picky_asn1_der::from_reader(&mut data).map_err(|e| Error::new(ErrorKind::InvalidToken, format!("{:?}", e)))?;

    // let oid: ObjectIdentifierAsn1 = picky_asn1_der::from_bytes(&oid.0.0)?;

    // let mut token_id = [0, 0];
    // data.read_exact(&mut token_id)?;

    // if token_id != AS_REP_TOKEN_ID {
    //     return Err(Error::new(
    //         ErrorKind::InvalidToken,
    //         format!("Invalid token id: {:?}. Expected: {:?}", token_id, AS_REP_TOKEN_ID),
    //     ));
    // }

    Ok((picky_asn1_der::from_bytes(data)?, data))
}

pub fn extract_pa_pk_as_rep(as_rep: &AsRep) -> Result<PaPkAsRep> {
    Ok(picky_asn1_der::from_bytes(
        &as_rep
            .0
            .padata
            .0
            .as_ref()
            .ok_or_else(|| Error::new(ErrorKind::InvalidToken, "pa-datas is not present in as rep".into()))?
            .iter()
            .find(|pa_data| &pa_data.padata_type.0 .0 == &PA_PK_AS_REP)
            .ok_or_else(|| {
                Error::new(
                    ErrorKind::InvalidToken,
                    "PA_PK_AS_REP is not present in pa-datas of the as rep".into(),
                )
            })?
            .padata_data
            .0
             .0,
    )?)
}

pub fn extract_server_nonce(dh_rep_info: &DhRepInfo) -> Result<[u8; DH_NONCE_LEN]> {
    let nonce = dh_rep_info
        .server_dh_nonce
        .0
        .as_ref()
        .map(|nonce| nonce.0 .0.clone())
        .ok_or_else(|| Error::new(ErrorKind::InvalidToken, "DH server nonce is not present".into()))?;

    if nonce.len() != DH_NONCE_LEN {
        return Err(Error::new(
            ErrorKind::InvalidToken,
            format!(
                "invalid server dh nonce length: {}. Expected: {}",
                nonce.len(),
                DH_NONCE_LEN
            ),
        ));
    }

    Ok(nonce.try_into().unwrap())
}

pub fn extract_server_dh_public_key(signed_data: &SignedData) -> Result<Vec<u8>> {
    let pkinit_dh_key_data = ObjectIdentifier::try_from(PKINIT_DH_KEY_DATA).unwrap();
    if signed_data.content_info.content_type.0 != pkinit_dh_key_data {
        return Err(Error::new(
            ErrorKind::InvalidToken,
            format!(
                "Invalid content info identifier: {:?}. Expected: {:?}",
                signed_data.content_info.content_type.0, pkinit_dh_key_data
            ),
        ));
    }

    let dh_key_info_data = match &signed_data
        .content_info
        .content
        .as_ref()
        .ok_or_else(|| Error::new(ErrorKind::InvalidToken, "content info is not present".into()))?
        .0
    {
        ContentValue::OctetString(data) => &data.0,
        _ => return Err(Error::new(ErrorKind::InvalidToken, "unexpected content info".into())),
    };

    let dh_key_info: KdcDhKeyInfo = picky_asn1_der::from_bytes(dh_key_info_data)?;

    if dh_key_info.nonce.0 != vec![0] {
        return Err(Error::new(
            ErrorKind::InvalidToken,
            format!("DH key nonce must be 0. Got: {:?}", dh_key_info.nonce.0),
        ));
    }

    let key: IntegerAsn1 = picky_asn1_der::from_bytes(dh_key_info.subject_public_key.0.payload_view())?;

    Ok(key.as_unsigned_bytes_be().to_vec())
}

#[cfg(test)]
mod tests {
    use picky_krb::messages::AsRep;

    use super::extract_krb_rep;

    #[test]
    fn as_rep_extraction() {
        let raw_message = [
            96, 130, 11, 218, 6, 6, 43, 6, 1, 5, 2, 7, 6, 0, 107, 130, 11, 204, 48, 130, 11, 200, 160, 3, 2, 1, 5, 161,
            3, 2, 1, 11, 162, 130, 6, 128, 48, 130, 6, 124, 48, 130, 6, 120, 161, 3, 2, 1, 17, 162, 130, 6, 111, 4,
            130, 6, 107, 160, 130, 6, 103, 48, 130, 6, 99, 128, 130, 6, 59, 48, 130, 6, 55, 2, 1, 3, 49, 11, 48, 9, 6,
            5, 43, 14, 3, 2, 26, 5, 0, 48, 129, 162, 6, 7, 43, 6, 1, 5, 2, 3, 2, 160, 129, 150, 4, 129, 147, 48, 129,
            144, 160, 129, 136, 3, 129, 133, 0, 2, 129, 129, 0, 218, 76, 235, 63, 222, 122, 67, 6, 210, 4, 219, 144,
            10, 253, 105, 197, 87, 1, 68, 61, 12, 232, 203, 120, 225, 215, 208, 224, 194, 49, 162, 89, 251, 216, 82,
            14, 92, 119, 236, 147, 132, 225, 80, 117, 104, 218, 221, 117, 104, 149, 33, 9, 225, 159, 16, 243, 57, 44,
            147, 221, 164, 8, 131, 5, 43, 219, 70, 8, 7, 60, 118, 39, 124, 30, 48, 205, 41, 150, 112, 133, 151, 136,
            121, 91, 56, 12, 251, 210, 239, 155, 85, 63, 244, 177, 112, 133, 181, 245, 110, 164, 31, 197, 241, 14, 137,
            195, 223, 226, 23, 158, 68, 27, 66, 118, 200, 170, 122, 33, 156, 104, 103, 155, 136, 28, 247, 8, 54, 20,
            161, 3, 2, 1, 0, 160, 130, 3, 179, 48, 130, 3, 175, 48, 130, 2, 151, 160, 3, 2, 1, 2, 2, 16, 85, 47, 30,
            63, 139, 118, 224, 166, 140, 108, 227, 232, 117, 255, 59, 249, 48, 13, 6, 9, 42, 134, 72, 134, 247, 13, 1,
            1, 11, 5, 0, 48, 77, 49, 75, 48, 73, 6, 3, 85, 4, 3, 30, 66, 0, 77, 0, 83, 0, 45, 0, 79, 0, 114, 0, 103, 0,
            97, 0, 110, 0, 105, 0, 122, 0, 97, 0, 116, 0, 105, 0, 111, 0, 110, 0, 45, 0, 80, 0, 50, 0, 80, 0, 45, 0,
            65, 0, 99, 0, 99, 0, 101, 0, 115, 0, 115, 0, 32, 0, 91, 0, 50, 0, 48, 0, 50, 0, 49, 0, 93, 48, 30, 23, 13,
            50, 50, 48, 53, 49, 55, 49, 57, 50, 52, 48, 54, 90, 23, 13, 50, 50, 48, 53, 49, 56, 49, 57, 50, 57, 48, 54,
            90, 48, 101, 49, 52, 48, 50, 6, 10, 9, 146, 38, 137, 147, 242, 44, 100, 1, 25, 22, 36, 52, 99, 53, 97, 53,
            101, 99, 49, 45, 57, 97, 99, 53, 45, 52, 54, 49, 50, 45, 57, 98, 52, 99, 45, 54, 98, 101, 100, 49, 55, 56,
            98, 98, 54, 53, 97, 49, 45, 48, 43, 6, 3, 85, 4, 3, 12, 36, 99, 99, 51, 100, 57, 54, 98, 52, 45, 48, 97,
            48, 100, 45, 52, 97, 53, 100, 45, 56, 98, 102, 98, 45, 56, 100, 54, 101, 97, 56, 100, 57, 53, 53, 100, 50,
            48, 130, 1, 34, 48, 13, 6, 9, 42, 134, 72, 134, 247, 13, 1, 1, 1, 5, 0, 3, 130, 1, 15, 0, 48, 130, 1, 10,
            2, 130, 1, 1, 0, 199, 77, 166, 39, 80, 222, 84, 115, 41, 66, 75, 180, 150, 219, 181, 13, 3, 102, 176, 46,
            8, 194, 243, 198, 233, 126, 112, 105, 214, 207, 85, 254, 186, 228, 217, 23, 28, 232, 31, 209, 227, 99, 220,
            60, 28, 78, 168, 51, 162, 48, 63, 120, 240, 186, 203, 224, 154, 164, 227, 78, 224, 4, 120, 160, 170, 134,
            185, 124, 156, 51, 235, 206, 20, 62, 191, 51, 182, 195, 7, 184, 139, 80, 198, 103, 40, 37, 155, 219, 95,
            56, 162, 242, 152, 249, 204, 236, 191, 67, 64, 180, 223, 13, 207, 32, 242, 203, 172, 126, 77, 90, 197, 6,
            32, 162, 179, 253, 86, 158, 233, 147, 176, 44, 132, 150, 128, 103, 128, 157, 185, 157, 131, 50, 142, 248,
            67, 68, 217, 122, 154, 103, 143, 101, 207, 136, 219, 79, 226, 0, 159, 117, 200, 43, 80, 95, 163, 247, 218,
            117, 69, 248, 88, 64, 5, 181, 63, 109, 247, 80, 141, 174, 38, 220, 64, 250, 3, 82, 187, 52, 243, 151, 141,
            237, 115, 115, 17, 199, 29, 213, 4, 197, 242, 40, 177, 141, 170, 241, 173, 179, 212, 100, 73, 102, 21, 255,
            74, 213, 158, 11, 241, 110, 82, 139, 142, 209, 118, 197, 15, 240, 243, 50, 39, 23, 243, 172, 152, 170, 75,
            97, 102, 169, 23, 245, 147, 180, 29, 22, 58, 3, 100, 35, 6, 98, 92, 164, 55, 39, 81, 87, 58, 25, 22, 31,
            234, 173, 200, 213, 2, 3, 1, 0, 1, 163, 115, 48, 113, 48, 14, 6, 3, 85, 29, 15, 1, 1, 255, 4, 4, 3, 2, 5,
            160, 48, 45, 6, 3, 85, 29, 17, 4, 38, 48, 36, 130, 11, 65, 90, 82, 68, 79, 87, 78, 45, 87, 49, 48, 130, 11,
            65, 90, 82, 68, 79, 87, 78, 45, 87, 49, 48, 130, 8, 49, 48, 46, 49, 46, 48, 46, 52, 48, 19, 6, 3, 85, 29,
            37, 4, 12, 48, 10, 6, 8, 43, 6, 1, 5, 5, 7, 3, 1, 48, 27, 6, 9, 43, 6, 1, 4, 1, 130, 55, 21, 10, 4, 14, 48,
            12, 48, 10, 6, 8, 43, 6, 1, 5, 5, 7, 3, 1, 48, 13, 6, 9, 42, 134, 72, 134, 247, 13, 1, 1, 11, 5, 0, 3, 130,
            1, 1, 0, 124, 211, 121, 241, 39, 108, 96, 140, 158, 149, 109, 212, 59, 78, 203, 168, 204, 137, 19, 171, 77,
            67, 61, 166, 94, 122, 197, 145, 118, 157, 192, 156, 113, 249, 60, 110, 33, 188, 169, 75, 137, 57, 64, 130,
            5, 128, 58, 248, 87, 211, 139, 50, 157, 138, 176, 226, 159, 239, 15, 103, 84, 126, 26, 147, 246, 82, 12,
            80, 56, 61, 192, 231, 75, 104, 125, 95, 59, 52, 28, 236, 7, 195, 239, 242, 49, 105, 113, 168, 210, 102,
            192, 207, 212, 185, 185, 100, 137, 250, 219, 180, 75, 84, 139, 15, 115, 187, 165, 170, 227, 48, 245, 58,
            91, 137, 220, 197, 161, 180, 99, 195, 82, 92, 119, 170, 199, 3, 161, 221, 211, 177, 124, 92, 195, 92, 210,
            165, 117, 41, 98, 234, 175, 123, 44, 252, 230, 121, 151, 208, 210, 165, 67, 150, 152, 200, 243, 21, 85,
            209, 223, 217, 73, 243, 38, 166, 60, 3, 6, 140, 26, 170, 243, 114, 205, 210, 117, 111, 235, 38, 42, 43,
            217, 170, 118, 150, 180, 38, 218, 39, 198, 156, 157, 182, 223, 198, 200, 13, 255, 101, 56, 124, 126, 126,
            10, 255, 166, 203, 26, 251, 140, 248, 229, 41, 19, 94, 135, 210, 18, 185, 30, 55, 23, 195, 54, 88, 140,
            174, 87, 65, 250, 143, 243, 163, 172, 142, 207, 190, 111, 113, 157, 204, 246, 0, 119, 11, 253, 208, 155,
            101, 40, 217, 188, 10, 14, 89, 120, 146, 49, 130, 1, 199, 48, 130, 1, 195, 2, 1, 1, 48, 97, 48, 77, 49, 75,
            48, 73, 6, 3, 85, 4, 3, 30, 66, 0, 77, 0, 83, 0, 45, 0, 79, 0, 114, 0, 103, 0, 97, 0, 110, 0, 105, 0, 122,
            0, 97, 0, 116, 0, 105, 0, 111, 0, 110, 0, 45, 0, 80, 0, 50, 0, 80, 0, 45, 0, 65, 0, 99, 0, 99, 0, 101, 0,
            115, 0, 115, 0, 32, 0, 91, 0, 50, 0, 48, 0, 50, 0, 49, 0, 93, 2, 16, 85, 47, 30, 63, 139, 118, 224, 166,
            140, 108, 227, 232, 117, 255, 59, 249, 48, 9, 6, 5, 43, 14, 3, 2, 26, 5, 0, 160, 61, 48, 22, 6, 9, 42, 134,
            72, 134, 247, 13, 1, 9, 3, 49, 9, 6, 7, 43, 6, 1, 5, 2, 3, 2, 48, 35, 6, 9, 42, 134, 72, 134, 247, 13, 1,
            9, 4, 49, 22, 4, 20, 207, 84, 215, 76, 61, 237, 27, 245, 186, 203, 116, 211, 41, 149, 95, 129, 147, 149,
            136, 166, 48, 13, 6, 9, 42, 134, 72, 134, 247, 13, 1, 1, 1, 5, 0, 4, 130, 1, 0, 111, 17, 1, 8, 116, 231,
            197, 34, 227, 186, 92, 57, 120, 101, 232, 20, 207, 52, 39, 202, 112, 40, 194, 203, 86, 55, 75, 186, 92, 52,
            55, 244, 26, 119, 58, 46, 200, 251, 185, 76, 244, 242, 18, 149, 207, 17, 126, 4, 41, 216, 89, 14, 137, 100,
            190, 70, 0, 183, 138, 152, 26, 56, 162, 219, 146, 159, 128, 68, 195, 190, 195, 32, 2, 64, 118, 220, 182,
            183, 218, 219, 145, 62, 246, 216, 214, 182, 244, 251, 97, 78, 232, 123, 167, 187, 154, 212, 10, 222, 244,
            232, 249, 194, 202, 26, 149, 174, 109, 15, 218, 247, 45, 209, 232, 92, 5, 87, 249, 192, 249, 91, 240, 160,
            7, 202, 196, 8, 161, 2, 41, 10, 242, 107, 43, 100, 45, 5, 75, 49, 222, 172, 249, 252, 196, 68, 71, 250,
            195, 11, 185, 161, 184, 39, 65, 22, 44, 78, 245, 132, 193, 63, 231, 94, 113, 116, 125, 210, 243, 106, 48,
            201, 50, 14, 177, 43, 168, 94, 39, 44, 221, 97, 60, 94, 230, 117, 248, 57, 143, 88, 117, 139, 75, 113, 97,
            48, 39, 13, 168, 2, 247, 89, 110, 216, 96, 161, 47, 183, 168, 204, 145, 221, 28, 174, 247, 196, 69, 212,
            187, 37, 162, 198, 33, 238, 127, 68, 191, 239, 233, 46, 240, 67, 151, 40, 76, 232, 41, 137, 233, 117, 199,
            11, 95, 201, 123, 246, 188, 44, 122, 105, 175, 179, 204, 127, 221, 57, 190, 66, 161, 34, 4, 32, 160, 135,
            139, 83, 106, 40, 32, 75, 125, 12, 23, 191, 191, 163, 215, 162, 217, 132, 196, 80, 212, 102, 88, 251, 252,
            135, 151, 137, 121, 58, 199, 71, 163, 17, 27, 15, 87, 69, 76, 76, 75, 78, 79, 87, 78, 58, 80, 75, 85, 50,
            85, 164, 45, 48, 43, 160, 3, 2, 1, 128, 161, 36, 48, 34, 27, 32, 65, 122, 117, 114, 101, 65, 68, 92, 109,
            97, 109, 111, 114, 101, 97, 117, 64, 100, 111, 119, 110, 104, 105, 108, 108, 112, 114, 111, 46, 120, 121,
            122, 165, 130, 3, 227, 97, 130, 3, 223, 48, 130, 3, 219, 160, 3, 2, 1, 5, 161, 17, 27, 15, 87, 69, 76, 76,
            75, 78, 79, 87, 78, 58, 80, 75, 85, 50, 85, 162, 33, 48, 31, 160, 3, 2, 1, 2, 161, 24, 48, 22, 27, 7, 84,
            69, 82, 77, 83, 82, 86, 27, 11, 65, 90, 82, 68, 79, 87, 78, 45, 87, 49, 48, 163, 130, 3, 156, 48, 130, 3,
            152, 160, 3, 2, 1, 18, 162, 130, 3, 143, 4, 130, 3, 139, 1, 206, 220, 195, 79, 122, 192, 180, 36, 196, 136,
            196, 220, 73, 91, 167, 233, 45, 204, 201, 148, 192, 68, 0, 158, 26, 246, 183, 80, 77, 153, 236, 156, 126,
            210, 232, 48, 59, 26, 118, 6, 208, 56, 26, 19, 197, 158, 79, 33, 215, 127, 55, 149, 23, 63, 180, 58, 196,
            63, 108, 78, 65, 240, 36, 188, 65, 121, 222, 12, 131, 194, 73, 28, 16, 4, 115, 76, 185, 80, 244, 103, 75,
            230, 191, 180, 210, 101, 133, 243, 33, 19, 30, 164, 27, 201, 91, 124, 212, 223, 174, 207, 49, 102, 46, 5,
            167, 14, 17, 239, 249, 1, 152, 83, 9, 15, 249, 52, 54, 49, 168, 215, 221, 197, 127, 66, 68, 126, 207, 82,
            33, 111, 74, 177, 66, 11, 39, 232, 23, 171, 34, 222, 28, 5, 192, 21, 181, 248, 7, 156, 232, 23, 226, 28,
            131, 247, 28, 247, 233, 191, 193, 15, 8, 36, 103, 57, 30, 126, 241, 186, 182, 154, 144, 167, 47, 148, 40,
            216, 51, 92, 85, 74, 35, 242, 108, 37, 41, 254, 16, 213, 10, 97, 73, 217, 95, 67, 118, 96, 160, 231, 185,
            127, 86, 130, 62, 129, 86, 225, 98, 36, 109, 190, 150, 34, 203, 57, 8, 134, 122, 113, 131, 25, 57, 6, 121,
            114, 58, 132, 130, 212, 218, 214, 106, 150, 67, 131, 157, 85, 100, 120, 163, 203, 16, 120, 184, 11, 6, 20,
            74, 223, 54, 118, 38, 122, 161, 255, 128, 112, 242, 161, 73, 73, 159, 83, 200, 90, 171, 216, 124, 125, 156,
            40, 56, 174, 192, 89, 243, 43, 29, 232, 77, 10, 28, 250, 8, 63, 151, 152, 104, 123, 123, 8, 207, 246, 58,
            85, 107, 160, 82, 157, 237, 236, 52, 67, 231, 169, 176, 155, 96, 64, 217, 222, 141, 122, 70, 26, 222, 134,
            181, 175, 234, 24, 98, 149, 212, 60, 35, 102, 40, 213, 148, 199, 127, 13, 213, 197, 69, 169, 62, 186, 132,
            195, 110, 141, 53, 102, 66, 202, 123, 209, 232, 133, 183, 7, 223, 22, 27, 124, 4, 13, 234, 16, 204, 214, 9,
            53, 227, 236, 127, 12, 64, 90, 162, 24, 36, 51, 209, 203, 45, 175, 107, 12, 49, 7, 213, 247, 49, 204, 37,
            235, 71, 157, 113, 10, 42, 122, 159, 170, 147, 186, 222, 183, 248, 108, 83, 54, 175, 113, 189, 148, 152,
            121, 133, 168, 26, 98, 225, 211, 34, 217, 69, 214, 208, 143, 31, 153, 255, 152, 101, 226, 144, 203, 168,
            203, 72, 182, 35, 183, 15, 172, 54, 127, 120, 56, 38, 199, 135, 192, 204, 30, 17, 68, 186, 77, 41, 138,
            126, 247, 231, 168, 133, 219, 205, 163, 132, 66, 215, 190, 6, 171, 149, 79, 114, 66, 236, 245, 248, 66,
            197, 29, 204, 222, 1, 208, 38, 214, 112, 61, 25, 238, 246, 201, 87, 10, 241, 229, 39, 228, 235, 132, 15,
            215, 19, 172, 88, 239, 186, 141, 165, 141, 114, 29, 135, 23, 139, 72, 206, 83, 52, 80, 71, 71, 96, 109, 73,
            119, 236, 50, 100, 156, 0, 231, 218, 225, 37, 227, 244, 49, 121, 115, 6, 149, 43, 199, 84, 51, 105, 137,
            49, 209, 91, 187, 160, 165, 17, 141, 65, 91, 117, 174, 29, 187, 42, 8, 198, 188, 145, 43, 252, 86, 154, 57,
            42, 180, 153, 158, 240, 237, 189, 157, 244, 74, 181, 142, 129, 106, 137, 146, 46, 75, 23, 52, 18, 113, 187,
            111, 80, 113, 169, 214, 75, 103, 225, 196, 42, 88, 102, 80, 55, 87, 228, 252, 126, 74, 13, 28, 43, 217,
            209, 221, 231, 77, 36, 179, 70, 252, 120, 119, 247, 92, 20, 138, 238, 234, 75, 186, 86, 235, 32, 72, 53,
            40, 157, 42, 242, 123, 147, 189, 197, 206, 117, 121, 45, 17, 165, 152, 153, 42, 208, 28, 236, 236, 185,
            216, 213, 147, 234, 66, 158, 41, 105, 166, 60, 37, 34, 115, 185, 3, 62, 77, 75, 169, 77, 226, 91, 140, 58,
            132, 214, 182, 254, 101, 233, 60, 84, 150, 166, 105, 205, 190, 48, 151, 86, 41, 130, 129, 217, 39, 111,
            228, 12, 221, 142, 43, 224, 18, 225, 85, 27, 104, 81, 196, 125, 248, 18, 134, 94, 38, 225, 173, 210, 198,
            138, 249, 204, 123, 69, 248, 206, 206, 75, 119, 17, 96, 118, 8, 119, 184, 142, 108, 4, 38, 147, 176, 25,
            138, 213, 90, 83, 73, 219, 227, 198, 165, 72, 206, 105, 228, 140, 64, 43, 134, 234, 239, 54, 236, 117, 129,
            97, 179, 56, 56, 135, 249, 41, 63, 29, 114, 204, 103, 252, 138, 186, 144, 1, 38, 61, 243, 33, 239, 119,
            235, 67, 199, 73, 92, 124, 64, 76, 0, 245, 37, 113, 103, 97, 180, 244, 208, 194, 41, 152, 252, 231, 13,
            251, 13, 240, 166, 19, 66, 78, 183, 47, 64, 204, 133, 29, 200, 189, 20, 134, 179, 203, 197, 160, 49, 157,
            152, 228, 33, 209, 114, 248, 35, 46, 163, 17, 239, 65, 15, 188, 234, 161, 167, 39, 222, 100, 139, 80, 0, 4,
            201, 204, 30, 7, 187, 233, 25, 208, 84, 107, 238, 60, 120, 147, 192, 151, 35, 134, 245, 89, 12, 113, 235,
            87, 114, 11, 112, 230, 220, 36, 94, 9, 105, 29, 183, 50, 159, 166, 130, 1, 13, 48, 130, 1, 9, 160, 3, 2, 1,
            18, 162, 130, 1, 0, 4, 129, 253, 62, 242, 7, 228, 43, 94, 177, 66, 185, 89, 38, 84, 238, 3, 18, 84, 199,
            99, 235, 203, 159, 159, 208, 53, 56, 51, 109, 123, 123, 122, 95, 9, 93, 11, 217, 142, 76, 36, 26, 139, 102,
            253, 138, 130, 44, 44, 84, 239, 73, 108, 79, 194, 61, 63, 16, 84, 185, 127, 228, 25, 136, 185, 192, 36,
            227, 219, 18, 111, 51, 254, 227, 176, 247, 0, 77, 30, 160, 12, 53, 184, 74, 139, 147, 124, 145, 200, 139,
            123, 146, 54, 72, 71, 154, 17, 113, 26, 221, 205, 46, 50, 234, 181, 210, 133, 209, 48, 168, 209, 180, 8, 3,
            201, 198, 172, 85, 169, 196, 142, 105, 180, 35, 110, 160, 103, 151, 102, 227, 172, 217, 82, 142, 230, 223,
            92, 92, 228, 36, 46, 94, 151, 255, 148, 76, 100, 55, 152, 228, 206, 185, 202, 128, 35, 25, 7, 233, 135,
            114, 98, 166, 29, 103, 179, 166, 189, 122, 200, 177, 14, 156, 222, 120, 104, 179, 117, 47, 209, 139, 196,
            95, 193, 121, 163, 38, 4, 12, 178, 117, 14, 85, 17, 4, 39, 242, 7, 166, 154, 178, 98, 51, 125, 205, 40,
            177, 225, 47, 227, 212, 186, 33, 0, 255, 113, 231, 112, 119, 145, 37, 26, 198, 9, 35, 108, 143, 47, 147,
            91, 163, 80, 142, 155, 208, 102, 97, 235, 50, 189, 90, 114, 94, 27, 237, 206, 97, 10, 121, 166, 24, 3, 248,
            187, 142, 204, 99,
        ];

        let (as_rep, _): (AsRep, _) = extract_krb_rep(&raw_message).unwrap();
        println!("{:?}", as_rep)
    }
}
